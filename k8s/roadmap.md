- Dockerのベースイメージにはdistrolessを使用する
    - パッケージマネージャ、シェルなどが入ってないためセキュリティ脆弱性が最小限、サイズが軽量
        - そのため、ビルドができないが、マルチステージビルドで解決できる
- Quay.ioでクラウドにコンテナレジストリを構築できる
- RailsをDockerで起動する際は、server.pidを削除するため、entrypoint.shを実行する
    - https://github.com/docker/awesome-compose/tree/master/official-documentation-samples/rails/
- Goの場合はビルドしたバイナリがあれば実行できるのでdistolessで起動できる
    - https://github.com/GoogleContainerTools/distroless/blob/main/examples/go/Dockerfile
    - https://docs.docker.com/language/golang/build-images/#multi-stage-builds
- PodDisruptionBudgetで安全なメンテナンスができる
- preStopでsleepさせるとアプリケーションを安全に停止できる
- 高度なJobの並列処理を行う場合は、CronJobでは機能が不足しているためArgo Workflowsなどが使える
- データベース構築、データのバックアップ、リストア、データベース自体のアップグレード処理を自動で行うkubernetes operatorを検討する
    - ノード数やデータ容量が大きい環境の場合推奨
    - https://operatorhub.io/
- Gateway API
    - Ingressの機能を提供するAPI
    - 役割に基づいてIngressリソースをGatewayリソースとxRouteリソースの２種類に分割したもの
- GitOps
    - コード用repo
        - テスト
        - コンテナビルド
            - タグがないイメージを削除するツールGCR Cleaner
        - 脆弱性スキャン
            - trivy
            - grype
        - SBOMの生成
            - コンテナイメージに含まれているOSパッケージやアプリケーションパッケージの部品表のこと
            - 脆弱性を持つコンテナイメージを特定できる
            - trivy, syft
        - レジストリへのプッシュ
        - コンフィグ用repoのmanifestを書き換える
    - コンフィグ用repo
        - シンタックスの確認
            - kubeconform
        - 特定のポリシーに合致しているかの確認
            - conftest
            - open policy agent
            - the gator cli
        - 廃止・削除されたAPI Versionを利用しているかの確認
             - pluto
    - CIOpsとの違い
        - CIOpsは、CIツールでデプロイを実行する
            - マージされたタイミグでCIジョブをトリガーし、マニフェストをフェッチしたあと、それらのファイルをKubernetesクラスタに適用する
        - GitOpsは、Kubernetesクラスタ上にDeploy Agentを配置し、マニフェストの取得とKubernetesクラスタに対する滝用を実行する
        - GitOpsのほうが推奨される
            - ツールに与えるk8sクラスタの操作権限の範囲を狭められる
                - すべてのマニフェストをk8sに適用するために、マニフェストを適用するCIツールにはNamespaceですべての操作が可能な強い権限を付与する必要がある
                - クラスタ外からk8s APIを叩けるようにする必要があるため、k8s APIにグローバルIPアドレスを付与したり、CIツールから疎通性のあるネットワークを構成するなどAPIを露出しなければならない
                - 一方GitOpsだと、deploy agentにgit repoに対するread権限のみ与えれば良い
                    - コンテナから接続するため、k8sAPIが公開されている
                        - k8sAPIをグローバル公開する必要がない
            - 複雑化を避けられる
                - CIツール側でデプロイ先のクラスタを制御する必要がある
                - GitOpsだと、どのコンフィグ用repoのどのブランチと同期を取るのかを最初に設定する
        - 複数クラスタを一元的に管理するならCIOpsのほうが適している場合もある
            - ArgoCDでも複数のクラスタを管理する場合は、クラスタ外にあるArgoCDから複数のクラスタを管理するアーキテクチャを取る
        - GitOpsの代表的ソフトウェア
            - ArgoCDやFluxCDがdeploy agentとしての役割を果たす
- マニフェストを効率的に管理するツール
    - helm
    - kustomize
- external secretsというoperatorがあり、repoで機密情報を管理しないようにできる
    - parameter storeも対応してそう
        - https://external-secrets.io/v0.5.7/provider-aws-parameter-store/
        - https://atmarkit.itmedia.co.jp/ait/articles/2209/29/news015.html
